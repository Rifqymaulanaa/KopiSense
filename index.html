<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KopiSense Web Dashboard</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase/Firestore Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (MUST be used)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kopisense-app';
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'simulated_user'; // Default for simulation

        window.firebaseInitPromise = new Promise(async (resolve) => {
            if (firebaseConfig) {
                try {
                    setLogLevel('Debug');
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            // Update the display with the real user ID
                            document.getElementById('user-id-display').textContent = ID Pengguna: ${userId.substring(0, 8)}...;
                        } else {
                            // Use a random ID if anonymous sign-in failed/user signed out
                            userId = crypto.randomUUID();
                            document.getElementById('user-id-display').textContent = ID Pengguna: ANONIM;
                        }
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId;
                        window.appId = appId;
                        resolve(true);
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    window.db = null;
                    window.auth = null;
                    window.userId = crypto.randomUUID();
                    window.appId = appId;
                    resolve(false);
                }
            } else {
                console.warn("Firebase config not available. Running in pure simulation mode.");
                resolve(false);
            }
        });
    </script>
    <!-- Set default font to Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Very light green */
        }
        /* Custom Colors based on Flutter App */
        .coffee-green { background-color: #4CAF50; }
        .text-coffee-green { color: #4CAF50; }
        .border-coffee-green { border-color: #4CAF50; }
        .earth-brown { color: #795548; }
        .text-error { color: #ef4444; } /* Red */
        .bg-error { background-color: #ef4444; }
        .text-success { color: #22c55e; } /* Green */
        .bg-success { background-color: #22c55e; }
        .glow-shadow { box-shadow: 0 10px 15px -3px rgba(76, 175, 80, 0.4), 0 4px 6px -2px rgba(76, 175, 80, 0.2); }
        .chart-target-line {
            position: absolute;
            bottom: 65%; /* Target 65% moisture level */
            left: 0;
            right: 0;
            height: 1px;
            background-color: #ff9800;
            border-top: 1px dashed #ff9800;
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="coffee-green shadow-xl sticky top-0 z-10">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center">
                    <!-- Leaf Icon Logo -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        <path d="M12.93 5.86c-1.39-1.29-3.41-1.29-4.8 0L7 7.02l.64.64a.5.5 0 00.7.01l.9-.9c1.07-.99 2.76-.99 3.83 0l.9.9a.5.5 0 00.7-.01l.64-.64-1.28-1.16zM9.5 15a.5.5 0 000-1H7a.5.5 0 000 1h2.5z" />
                    </svg>
                    <h1 id="header-title" class="text-white text-2xl font-extrabold">KopiSense Dashboard</h1>
                </div>
                <span id="user-id-display" class="text-white text-xs opacity-80">ID Pengguna: petani_kopi_001</span>
            </div>
        </header>

        <!-- Main Content Container -->
        <main class="p-4 md:p-6 pb-20">
            <div id="content">
                <!-- Content will be rendered here (Home, History, Settings) -->
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 z-20 flex flex-col items-center justify-center hidden">
            <!-- Loading Indicator (Tetesan Air Beranimasi) -->
            <div class="relative w-20 h-20 mb-6">
                <svg class="absolute inset-0 w-full h-full text-coffee-green opacity-30 animate-ping" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.45C5.4 15.35 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.85-8.55 11.4L12 21.35z"/></svg>
                <svg class="relative w-full h-full text-coffee-green" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.45C5.4 15.35 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.85-8.55 11.4L12 21.35z"/>
                </svg>
            </div>
            <p class="text-xl text-coffee-green font-semibold mb-3">Menghubungkan ke Kebun Kopi...</p>
            <div class="w-64 bg-gray-200 rounded-full h-3">
                <div class="bg-coffee-green h-3 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-green-100 shadow-2xl h-16 flex justify-around items-center">
            <button onclick="setTab('home')" id="nav-home" class="nav-item flex flex-col items-center p-2 text-coffee-green transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 13c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                <span class="text-xs font-semibold">Home</span>
            </button>
            <button onclick="setTab('history')" id="nav-history" class="nav-item flex flex-col items-center p-2 text-gray-500 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.944 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                <span class="text-xs">Riwayat Data</span>
            </button>
            <button onclick="setTab('settings')" id="nav-settings" class="nav-item flex flex-col items-center p-2 text-gray-500 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.228.423 3.034-.572z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs">Pengaturan</span>
            </button>
        </nav>

        <!-- Message Box Container -->
        <div id="message-box-container" class="fixed inset-0 bg-black bg-opacity-40 z-30 hidden items-center justify-center p-4" onclick="closeMessageBox()">
            <div id="message-box" class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                <div class="flex items-center mb-4">
                    <svg id="msg-icon" class="h-8 w-8 text-success mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    <h3 id="msg-title" class="text-xl font-bold">Judul Pesan</h3>
                </div>
                <p id="msg-content" class="text-gray-600 mb-6">Isi pesan di sini.</p>
                <button onclick="closeMessageBox()" class="w-full py-2 bg-coffee-green text-white font-semibold rounded-xl transition hover:bg-green-600 transform hover:scale-[0.99]">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE APLIKASI ---
        let appState = {
            activeTab: 'home',
            isFirebaseReady: false,
            isLoading: false,
            // System Status (Simulasi data dari IoT/Firebase)
            isSprayingActive: false,
            isFertilizerMode: false,
            soilMoisture: 60, // Dummy data awal 60%
            isLowMoistureAlert: false,
            // Data History (Dummy Data)
            waterHistory: [],
            moistureHistory: [60, 45, 70, 55, 62, 48, 75], // Dummy data kelembaban 7 hari
            moistureSimulationTimer: null,
            
            // Konstan Warna
            COLOR_GREEN: '#4CAF50',
            COLOR_BROWN: '#795548',
            COLOR_RED: '#ef4444',
            COLOR_SUCCESS: '#22c55e'
        };

        // --- INISIALISASI DATA AWAL ---
        function initializeData() {
            const now = new Date();
            // Simulasi data log air untuk 7 hari terakhir (5 to 25 Liters)
            appState.waterHistory = Array.from({ length: 7 }, (_, index) => {
                const date = new Date(now);
                date.setDate(now.getDate() - index);
                return {
                    timestamp: date,
                    volumeLiters: (Math.random() * 20 + 5).toFixed(1)
                };
            }).reverse();
        }
        
        // Helper function to format date
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        // --- SIMULASI REAL-TIME (Pembaruan Kelembaban) ---
        function startRealtimeSimulation() {
            if (appState.moistureSimulationTimer) {
                clearInterval(appState.moistureSimulationTimer);
            }

            appState.moistureSimulationTimer = setInterval(() => {
                const currentMoisture = appState.soilMoisture;
                const minMoisture = 20;
                const maxMoisture = 85;

                // Perubahan acak antara -5 dan +5
                const change = Math.floor(Math.random() * 11) - 5; 
                let newMoisture = Math.max(minMoisture, Math.min(maxMoisture, currentMoisture + change));

                // Cek Notifikasi
                const isLowAlert = newMoisture < 40;
                if (isLowAlert && !appState.isLowMoistureAlert) {
                    showMessageBox('PERINGATAN!', Kelembaban terlalu rendah: ${newMoisture}%. Segera bertindak!, true);
                }
                
                // Update State
                appState.soilMoisture = newMoisture;
                appState.isLowMoistureAlert = isLowAlert;

                // Update History (simulasi)
                if (appState.moistureHistory.length >= 7) {
                    appState.moistureHistory.shift();
                }
                appState.moistureHistory.push(newMoisture);
                
                // Render hanya jika berada di Home atau History
                if (appState.activeTab === 'home' || appState.activeTab === 'history') {
                    render();
                }

            }, 5000); // Update setiap 5 detik
        }

        // --- FUNGSI KONTROL JARAK JAUH ---
        async function updateControl(type) {
            if (!appState.isFirebaseReady) {
                showMessageBox('Peringatan', 'Sistem belum terhubung ke database. Berjalan dalam mode simulasi.', true);
            }

            appState.isLoading = true;
            renderLoading();

            // Simulasi jeda jaringan/API
            await new Promise(resolve => setTimeout(resolve, 1000));

            try {
                let message = 'Status sistem berhasil diperbarui.';
                
                if (type === 'spray') {
                    appState.isSprayingActive = !appState.isSprayingActive;
                    // TODO: Implement actual Firebase/MQTT command here if appState.isFirebaseReady is true
                    message = appState.isSprayingActive ? 'Perintah: NYALAKAN IRIGASI telah terkirim.' : 'Perintah: MATIKAN IRIGASI telah terkirim.';
                } else if (type === 'fertilizer') {
                    appState.isFertilizerMode = !appState.isFertilizerMode;
                    // TODO: Implement actual Firebase/MQTT command here
                    message = appState.isFertilizerMode ? 'Mode Pupuk Cair diaktifkan.' : 'Mode Normal diaktifkan.';
                }
                
                showMessageBox('Perintah Terkirim!', message);

            } catch (e) {
                showMessageBox('Gagal', Gagal mengirim perintah: ${e.message}, true);
            } finally {
                appState.isLoading = false;
                render();
            }
        }

        // --- UI HELPER: MESSAGE BOX (Pengganti Alert) ---
        function showMessageBox(title, content, isError = false) {
            const container = document.getElementById('message-box-container');
            const icon = document.getElementById('msg-icon');
            const titleEl = document.getElementById('msg-title');
            const contentEl = document.getElementById('msg-content');

            container.classList.remove('hidden');
            container.classList.add('flex');
            titleEl.textContent = title;
            contentEl.textContent = content;

            // Update icon and color
            if (isError) {
                icon.innerHTML = '<path fill-rule="evenodd" d="M8.257 3.099c1.554-2.827 5.636-2.827 7.19 0l8.847 16.082A4 4 0 0120.5 23H3.5a4 4 0 01-3.693-5.819l8.847-16.082zM12 9a1 1 0 011 1v4a1 1 0 11-2 0v-4a1 1 0 011-1zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>'; // Warning icon
                icon.classList.remove('text-success');
                icon.classList.add('text-error');
                document.getElementById('message-box').style.borderColor = appState.COLOR_RED;
            } else {
                icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>'; // Check icon
                icon.classList.remove('text-error');
                icon.classList.add('text-success');
                document.getElementById('message-box').style.borderColor = appState.COLOR_GREEN;
            }
            document.getElementById('message-box').classList.add('animate-in'); // Simple animation class
        }

        function closeMessageBox() {
            document.getElementById('message-box-container').classList.add('hidden');
            document.getElementById('message-box-container').classList.remove('flex');
            document.getElementById('message-box').classList.remove('animate-in');
        }

        // --- RENDERING FUNGSI UTAMA ---
        function setTab(tab) {
            appState.activeTab = tab;
            const titles = {
                'home': 'Dashboard',
                'history': 'Riwayat Data',
                'settings': 'Pengaturan'
            };
            document.getElementById('header-title').textContent = titles[tab];
            
            // Update nav styles
            document.querySelectorAll('.nav-item').forEach(item => {
                const itemTab = item.id.replace('nav-', '');
                if (itemTab === tab) {
                    item.classList.remove('text-gray-500');
                    item.classList.add('text-coffee-green', 'font-semibold');
                } else {
                    item.classList.remove('text-coffee-green', 'font-semibold');
                    item.classList.add('text-gray-500');
                }
            });

            render();
        }

        function renderLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (appState.isLoading) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function render() {
            const content = document.getElementById('content');
            content.innerHTML = ''; 

            renderLoading();

            switch (appState.activeTab) {
                case 'home':
                    content.innerHTML = renderHomeScreen();
                    break;
                case 'history':
                    content.innerHTML = renderHistoryScreen();
                    break;
                case 'settings':
                    content.innerHTML = renderSettingsScreen();
                    break;
            }
            // Re-attach event listeners after innerHTML update
            if (appState.activeTab === 'home') {
                document.getElementById('toggle-spray').onclick = () => updateControl('spray');
                document.getElementById('toggle-fertilizer').onclick = () => updateControl('fertilizer');
            }
        }


        // --- WIDGET RENDERERS (HTML Strings) ---

        // 1. HOME SCREEN
        function renderHomeScreen() {
            return `
                <p class="text-sm text-gray-500 mb-4 font-medium">Hari Ini: ${formatDate(new Date())}</p>
                ${renderWelcomeCard()}
                <div class="mt-5">
                    ${renderMoistureStatusCard()}
                </div>
                <h2 class="text-xl earth-brown font-bold mt-6 mb-3">Kontrol Jarak Jauh</h2>
                ${renderRemoteControlPanel()}
            `;
        }

        function renderWelcomeCard() {
            return `
                <div class="p-5 rounded-2xl border-2 border-coffee-green bg-coffee-green bg-opacity-10 shadow-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-coffee-green mr-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        <path d="M12.93 5.86c-1.39-1.29-3.41-1.29-4.8 0L7 7.02l.64.64a.5.5 0 00.7.01l.9-.9c1.07-.99 2.76-.99 3.83 0l.9.9a.5.5 0 00.7-.01l.64-.64-1.28-1.16zM9.5 15a.5.5 0 000-1H7a.5.5 0 000 1h2.5z" />
                    </svg>
                    <div>
                        <h3 class="text-xl font-extrabold text-coffee-green">Selamat Datang di KopiSense</h3>
                        <p class="text-sm text-gray-700 mt-1">Solusi Cerdas untuk Kebun Kopimu. Kontrol irigasi, monitor data, dan optimalkan panen!</p>
                    </div>
                </div>
            `;
        }

        function renderMoistureStatusCard() {
            const moisture = appState.soilMoisture;
            let moistureColor = appState.COLOR_SUCCESS;
            let statusText = 'Kelembaban Ideal. Kebun Kopi Sehat.';

            if (moisture < 40) {
                moistureColor = appState.COLOR_RED;
                statusText = 'âš  Kritis! Segera Lakukan Penyiraman.';
            } else if (moisture < 65) {
                moistureColor = '#ff9800'; // Orange
            }

            const progressWidth = moisture; // Directly use percentage for width

            return `
                <div class="bg-white rounded-2xl shadow-xl p-5">
                    <h3 class="text-lg font-bold earth-brown flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-coffee-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.944 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                        Pemantauan Tanah Real-Time
                    </h3>
                    <hr class="my-3 border-gray-100">
                    <div class="flex justify-between items-center my-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-coffee-green flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4 4 0 003 15z" /></svg>
                        <p class="text-7xl font-extrabold" style="color: ${moistureColor};">${moisture}%</p>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                        <div class="h-5 rounded-full transition-all duration-500" style="width: ${progressWidth}%; background-color: ${moistureColor};"></div>
                    </div>
                    <p class="mt-4 font-bold text-sm" style="color: ${moistureColor};">${statusText}</p>
                </div>
            `;
        }

        function renderRemoteControlPanel() {
            const sprayActive = appState.isSprayingActive;
            const fertilizerMode = appState.isFertilizerMode;

            const sprayButtonColor = sprayActive ? appState.COLOR_RED : appState.COLOR_GREEN;
            const sprayButtonText = sprayActive ? 'MATIKAN IRIGASI' : 'NYALAKAN IRIGASI';
            const statusChipText = sprayActive ? 'AKTIF' : 'NONAKTIF';
            const statusChipBg = sprayActive ? appState.COLOR_SUCCESS : appState.COLOR_RED;
            
            // Pulsating effect for active status
            const pulseClass = sprayActive ? 'relative' : 'relative';
            const pulseDot = sprayActive ? '<span class="absolute right-0 top-0 block h-3 w-3 rounded-full ring-2 ring-white bg-success opacity-75 animate-ping"></span><span class="absolute right-0 top-0 block h-3 w-3 rounded-full bg-success"></span>' : '';

            return `
                <div class="bg-white rounded-2xl shadow-xl p-5">
                    <!-- Status Sistem -->
                    <div class="flex justify-between items-center mb-4">
                        <p class="font-bold text-lg earth-brown">Status Penyiraman</p>
                        <div class="${pulseClass}">
                            <div class="flex items-center rounded-full pl-3 pr-5 py-2 font-extrabold text-white text-base shadow-md" style="background-color: ${statusChipBg};">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    ${sprayActive 
                                        ? '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>' // Water drop-like (or info)
                                        : '<path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.43 7.76 19 9.77 19 12c0 3.86-3.14 7-7 7s-7-3.14-7-7c0-2.23 1.57-4.24 3.73-5.41L6.17 5.17C3.33 6.64 1 9.42 1 12c0 5.52 4.48 10 10 10s10-4.48 10-10c0-2.58-2.33-5.36-5.17-6.83z"/>' // Power off
                                    }
                                </svg>
                                ${statusChipText}
                            </div>
                            ${pulseDot}
                        </div>
                    </div>
                    <hr class="my-4 border-gray-100">
                    
                    <!-- Tombol ON/OFF Irigasi -->
                    <button id="toggle-spray" class="w-full py-4 text-xl font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[0.99] ${sprayActive ? 'bg-error hover:bg-red-600' : 'bg-success hover:bg-green-600'}">
                        ${sprayButtonText}
                    </button>
                    <div class="my-4"></div>

                    <!-- Mode Pupuk -->
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-bold text-lg earth-brown">Mode Pupuk Cair</p>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-fertilizer" ${fertilizerMode ? 'checked' : ''} class="sr-only peer">
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-coffee-green"></div>
                        </label>
                    </div>

                    <!-- Status Mode Detail -->
                    <div class="p-3 rounded-lg text-center font-bold ${fertilizerMode ? 'bg-coffee-green bg-opacity-15 text-coffee-green' : 'bg-gray-100 text-gray-600'}">
                        ${fertilizerMode ? 'MODE AKTIF: PUPUK (Optimasi Nutrisi)' : 'MODE AKTIF: NORMAL (Hanya Air)'}
                    </div>
                </div>
            `;
        }

        // 2. HISTORY SCREEN
        function renderHistoryScreen() {
            return `
                <h2 class="text-2xl earth-brown font-bold mb-3">Riwayat Kelembaban Tanah (7 Hari)</h2>
                <p class="text-sm text-gray-600 mb-4">Pantau tren kelembaban untuk perencanaan irigasi optimal.</p>
                ${renderMoistureChartSimulation()}
                <h2 class="text-2xl earth-brown font-bold mt-8 mb-3">Riwayat Penggunaan Air (Liters)</h2>
                ${renderWaterHistoryList()}
            `;
        }

        function renderMoistureChartSimulation() {
            const history = appState.moistureHistory;
            if (history.length === 0) {
                return '<p class="text-center text-gray-500 py-8 bg-white rounded-xl shadow-sm">Tidak ada data kelembaban.</p>';
            }

            const maxHeight = 120; // Height in px for 100% moisture
            const bars = history.map((moisture, index) => {
                let color = appState.COLOR_SUCCESS;
                if (moisture < 40) {
                    color = appState.COLOR_RED;
                } else if (moisture < 65) {
                    color = '#ff9800'; // Orange
                }
                const barHeight = (moisture / 100) * maxHeight;
                const dayIndex = history.length - 1 - index; // H-0 is the latest
                const dayLabel = dayIndex === 0 ? 'Hari Ini' : H-${dayIndex};

                return `
                    <div class="flex flex-col items-center justify-end h-full">
                        <span class="text-xs font-bold mb-1" style="color: ${color};">${moisture}%</span>
                        <div class="w-6 rounded-t-md shadow-lg transition-all duration-500 transform hover:scale-105" style="height: ${barHeight}px; background-color: ${color};"></div>
                        <span class="text-xs text-gray-600 mt-2">${dayLabel}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-2xl shadow-xl p-4 relative">
                    <!-- Target Line (65% of 120px height) -->
                    <div class="absolute left-4 right-4" style="bottom: 120px; z-index: 1;">
                        <span class="absolute left-0 -top-2 text-xs text-orange-500 font-bold">Target 65%</span>
                        <hr class="border-orange-500 border-dashed border-t-2 opacity-70">
                    </div>

                    <div class="h-48 flex justify-around items-end p-2 border-b border-gray-300 relative z-2">
                        ${bars}
                    </div>
                </div>
            `;
        }

        function renderWaterHistoryList() {
            const logs = appState.waterHistory;
            return logs.map(log => {
                const volume = parseFloat(log.volumeLiters);
                let status = 'Rendah';
                let statusColor = appState.COLOR_SUCCESS;
                if (volume > 20) {
                    status = 'Tinggi';
                    statusColor = appState.COLOR_RED;
                } else if (volume > 10) {
                    status = 'Sedang';
                    statusColor = '#ff9800'; // Orange
                }

                const dateString = ${log.timestamp.getDate()}/${log.timestamp.getMonth() + 1}/${log.timestamp.getFullYear()};

                return `
                    <div class="bg-white rounded-xl shadow-lg p-4 mb-3 flex items-center justify-between transition duration-200 hover:bg-gray-50">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-coffee-green mr-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            <div>
                                <p class="font-extrabold text-lg earth-brown">${log.volumeLiters} Liter</p>
                                <p class="text-xs text-gray-500">Tanggal Penyiraman: ${dateString}</p>
                            </div>
                        </div>
                        <div class="font-extrabold text-sm px-3 py-1 rounded-full text-white" style="background-color: ${statusColor};">${status}</div>
                    </div>
                `;
            }).join('');
        }

        // 3. SETTINGS SCREEN
        function renderSettingsScreen() {
            return `
                <h2 class="text-2xl earth-brown font-bold mb-4">Pengaturan Sistem</h2>
                <div class="bg-white rounded-2xl shadow-xl divide-y divide-gray-100">
                    <div class="flex justify-between items-center p-5">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-earth-brown mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <div>
                                <p class="font-medium text-lg">Akun Pengguna</p>
                                <p class="text-xs text-gray-500">ID Aplikasi: kopisense-v1</p>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    </div>
                    
                    <div class="flex justify-between items-center p-5">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-coffee-green mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.47 6.036 6 8.243 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            <div>
                                <p class="font-medium text-lg">Batas Notifikasi</p>
                                <p class="text-xs text-gray-500">Kelembaban di bawah 40%</p>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    </div>

                    <div class="flex justify-between items-center p-5">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-coffee-green mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9.25 10m-.25 7V10m6 7l.25-7m-.25 7V10m-3 7L12 10m-3 7h6m-3 0V10" /></svg>
                            <div>
                                <p class="font-medium text-lg">Mode Irigasi Otomatis (Beta)</p>
                                <p class="text-xs text-gray-500">Irigasi berjalan otomatis berdasarkan sensor.</p>
                            </div>
                        </div>
                        <!-- Toggle Switch (Placeholder) -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer">
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-coffee-green"></div>
                        </label>
                    </div>

                    <div class="flex justify-between items-center p-5 text-gray-500">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div>
                                <p class="font-medium text-lg">Versi Aplikasi</p>
                                <p class="text-xs">KopiSense 1.0.0 (Build 20251021)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- INTI APLIKASI ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeData();
            // Wait for Firebase to initialize and authenticate before proceeding
            await window.firebaseInitPromise;
            appState.isFirebaseReady = true;

            startRealtimeSimulation();
            setTab('home'); // Initial render
        });
    </script>
</body>
</html>
